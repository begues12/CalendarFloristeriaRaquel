{% extends "base.html" %}

{% block title %}Gestor de Base de Datos - Florister√≠a Raquel{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="fas fa-database"></i> Gestor de Base de Datos</h2>
                    <p class="text-muted">Administraci√≥n avanzada de la base de datos</p>
                </div>
                <div>
                    <a href="{{ url_for('admin.database_config') }}" class="btn btn-outline-secondary me-2">
                        <i class="fas fa-cogs"></i> Configuraci√≥n
                    </a>
                    <a href="{{ url_for('admin.super_admin_panel') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Volver al Panel
                    </a>
                </div>
            </div>

            <!-- Informaci√≥n General -->
            <div class="row mb-4">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0"><i class="fas fa-info-circle"></i> Informaci√≥n de la Base de Datos</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <table class="table table-sm table-borderless">
                                        <tr>
                                            <td><strong>Motor:</strong></td>
                                            <td>{{ db_info.dialect.title() }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Driver:</strong></td>
                                            <td>{{ db_info.driver }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>URI:</strong></td>
                                            <td><small class="text-muted">{{ db_info.engine[:50] }}...</small></td>
                                        </tr>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <table class="table table-sm table-borderless">
                                        <tr>
                                            <td><strong>Total Tablas:</strong></td>
                                            <td><span class="badge bg-info">{{ db_info.stats.total_tables }}</span></td>
                                        </tr>
                                        <tr>
                                            <td><strong>Total Registros:</strong></td>
                                            <td><span class="badge bg-success">{{ db_info.stats.total_records }}</span></td>
                                        </tr>
                                        <tr>
                                            <td><strong>Pool Conexiones:</strong></td>
                                            <td>{{ db_info.stats.connection_pool_size }} / {{ db_info.stats.connection_pool_checked_out }}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header bg-warning text-dark">
                            <h6 class="mb-0"><i class="fas fa-tools"></i> Herramientas de Optimizaci√≥n</h6>
                        </div>
                        <div class="card-body">
                            <form method="POST" action="{{ url_for('admin.database_optimize') }}">
                                {% if db_info.dialect == 'mysql' %}
                                <div class="mb-3">
                                    <label class="form-label">Tipo de optimizaci√≥n:</label>
                                    <select name="optimization_type" class="form-select form-select-sm">
                                        <option value="analyze">Analizar Tablas</option>
                                        <option value="optimize">Optimizar Tablas</option>
                                    </select>
                                </div>
                                {% elif db_info.dialect == 'sqlite' %}
                                <div class="mb-3">
                                    <label class="form-label">Tipo de optimizaci√≥n:</label>
                                    <select name="optimization_type" class="form-select form-select-sm">
                                        <option value="vacuum">VACUUM</option>
                                        <option value="analyze">ANALYZE</option>
                                    </select>
                                </div>
                                {% endif %}
                                <button type="submit" class="btn btn-warning btn-sm w-100">
                                    <i class="fas fa-wrench"></i> Optimizar
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Consulta SQL -->
            <div class="card mb-4">
                <div class="card-header bg-dark text-white">
                    <h6 class="mb-0"><i class="fas fa-terminal"></i> Ejecutor de Consultas SQL (Acceso Completo)</h6>
                </div>
                <div class="card-body">
                    <div class="alert alert-success">
                        <i class="fas fa-unlock"></i>
                        <strong>Acceso Total:</strong> Puedes ejecutar cualquier consulta SQL (SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, etc.)
                    </div>
                    
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="sql-query" class="form-label">Consulta SQL:</label>
                                <textarea id="sql-query" class="form-control" rows="4" 
                                          placeholder="SELECT * FROM users LIMIT 10;&#10;INSERT INTO users (username, email) VALUES ('nuevo', 'email@test.com');&#10;UPDATE users SET is_admin = 1 WHERE username = 'admin';&#10;CREATE TABLE nueva_tabla (id INT PRIMARY KEY, nombre VARCHAR(100));"></textarea>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Consultas R√°pidas:</label>
                            <div class="btn-group-vertical w-100" role="group">
                                <button class="btn btn-outline-primary btn-sm" onclick="setQuery('SHOW TABLES;')">
                                    üìã Mostrar Tablas
                                </button>
                                <button class="btn btn-outline-primary btn-sm" onclick="setQuery('SELECT * FROM users LIMIT 10;')">
                                    üë• Ver Usuarios
                                </button>
                                <button class="btn btn-outline-primary btn-sm" onclick="setQuery('SELECT COUNT(*) as total FROM users;')">
                                    üî¢ Contar Usuarios
                                </button>
                                <button class="btn btn-outline-info btn-sm" onclick="setQuery('DESCRIBE users;')">
                                    üìù Estructura Users
                                </button>
                                <button class="btn btn-outline-warning btn-sm" onclick="setQuery('SHOW CREATE TABLE users;')">
                                    üèóÔ∏è DDL Users
                                </button>
                                <button class="btn btn-outline-success btn-sm" onclick="setQuery('SELECT table_name, table_rows FROM information_schema.tables WHERE table_schema = DATABASE();')">
                                    üìä Stats Tablas
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <button onclick="executeSQL()" class="btn btn-success me-2">
                                <i class="fas fa-play"></i> Ejecutar Consulta
                            </button>
                            <button onclick="clearQuery()" class="btn btn-outline-secondary">
                                <i class="fas fa-eraser"></i> Limpiar
                            </button>
                        </div>
                        <small class="text-success">‚úÖ Todas las consultas SQL est√°n permitidas</small>
                    </div>
                    
                    <!-- Resultados -->
                    <div id="sql-results" class="mt-3" style="display: none;">
                        <hr>
                        <h6>Resultados:</h6>
                        <div id="sql-output"></div>
                    </div>
                </div>
            </div>

            <!-- Tablas de la Base de Datos -->
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="fas fa-table"></i> Tablas de la Base de Datos</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Tabla</th>
                                    <th>Columnas</th>
                                    <th>√çndices</th>
                                    <th>Registros</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for table in db_info.tables %}
                                <tr>
                                    <td>
                                        <strong>{{ table.name }}</strong>
                                        <br><small class="text-muted">{{ table.records }} registros</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">{{ table.columns }}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ table.indexes }}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-success">{{ table.records }}</span>
                                    </td>
                                    <td>
                                        <div class="btn-group-vertical btn-group-sm" role="group">
                                            <button class="btn btn-outline-primary btn-sm" 
                                                    onclick="setQuery('SELECT * FROM {{ table.name }} LIMIT 10;')">
                                                <i class="fas fa-eye"></i> Ver Datos
                                            </button>
                                            <button class="btn btn-outline-info btn-sm" 
                                                    onclick="setQuery('DESCRIBE {{ table.name }};')">
                                                <i class="fas fa-list"></i> Estructura
                                            </button>
                                            <button class="btn btn-outline-secondary btn-sm" 
                                                    onclick="toggleTableDetails('{{ table.name }}')">
                                                <i class="fas fa-info-circle"></i> Detalles
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                
                                <!-- Detalles de la tabla (oculto por defecto) -->
                                <tr id="details-{{ table.name }}" style="display: none;">
                                    <td colspan="5">
                                        <div class="card">
                                            <div class="card-body">
                                                <h6>Columnas de {{ table.name }}:</h6>
                                                <div class="table-responsive">
                                                    <table class="table table-sm table-bordered">
                                                        <thead>
                                                            <tr>
                                                                <th>Nombre</th>
                                                                <th>Tipo</th>
                                                                <th>Nullable</th>
                                                                <th>Default</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for column in table.column_details %}
                                                            <tr>
                                                                <td><code>{{ column.name }}</code></td>
                                                                <td><span class="badge bg-light text-dark">{{ column.type }}</span></td>
                                                                <td>
                                                                    {% if column.nullable %}
                                                                        <span class="badge bg-warning">YES</span>
                                                                    {% else %}
                                                                        <span class="badge bg-danger">NO</span>
                                                                    {% endif %}
                                                                </td>
                                                                <td>
                                                                    {% if column.default %}
                                                                        <code>{{ column.default }}</code>
                                                                    {% else %}
                                                                        <span class="text-muted">NULL</span>
                                                                    {% endif %}
                                                                </td>
                                                            </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function setQuery(query) {
    document.getElementById('sql-query').value = query;
}

function clearQuery() {
    document.getElementById('sql-query').value = '';
    document.getElementById('sql-results').style.display = 'none';
}

function toggleTableDetails(tableName) {
    const detailsRow = document.getElementById('details-' + tableName);
    if (detailsRow.style.display === 'none') {
        detailsRow.style.display = 'table-row';
    } else {
        detailsRow.style.display = 'none';
    }
}

function executeSQL() {
    const query = document.getElementById('sql-query').value.trim();
    
    if (!query) {
        alert('Por favor ingresa una consulta SQL');
        return;
    }
    
    const resultsDiv = document.getElementById('sql-results');
    const outputDiv = document.getElementById('sql-output');
    
    // Mostrar loading
    resultsDiv.style.display = 'block';
    outputDiv.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Ejecutando consulta...</div>';
    
    fetch('{{ url_for("admin.execute_sql") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'sql_query=' + encodeURIComponent(query)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            outputDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Error:</strong> ${data.error}
                    <br><small><strong>Consulta:</strong> <code>${data.query}</code></small>
                </div>
            `;
        } else if (data.success) {
            if (data.columns && data.rows) {
                // Mostrar resultados en tabla
                let tableHtml = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i>
                        Consulta ejecutada exitosamente. ${data.row_count} filas retornadas.
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-sm">
                            <thead class="table-dark">
                                <tr>
                `;
                
                // Headers
                data.columns.forEach(col => {
                    tableHtml += `<th>${col}</th>`;
                });
                tableHtml += '</tr></thead><tbody>';
                
                // Rows (limitar a 100 filas para rendimiento)
                const maxRows = Math.min(data.rows.length, 100);
                for (let i = 0; i < maxRows; i++) {
                    const row = data.rows[i];
                    tableHtml += '<tr>';
                    row.forEach(cell => {
                        // Truncar celdas muy largas
                        const cellContent = cell.length > 100 ? cell.substring(0, 100) + '...' : cell;
                        tableHtml += `<td title="${cell}">${cellContent}</td>`;
                    });
                    tableHtml += '</tr>';
                }
                
                if (data.rows.length > 100) {
                    tableHtml += `<tr><td colspan="${data.columns.length}" class="text-center text-muted">
                        <i class="fas fa-info-circle"></i> Mostrando solo las primeras 100 filas de ${data.rows.length}
                    </td></tr>`;
                }
                
                tableHtml += '</tbody></table></div>';
                outputDiv.innerHTML = tableHtml;
            } else {
                // Para consultas de modificaci√≥n (INSERT, UPDATE, DELETE, etc.)
                const affectedRows = data.affected_rows || 0;
                outputDiv.innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i>
                        ${data.message || 'Consulta ejecutada correctamente'}
                        ${affectedRows > 0 ? `<br><strong>Filas afectadas:</strong> ${affectedRows}` : ''}
                        <br><small><strong>Consulta:</strong> <code>${data.query}</code></small>
                    </div>
                `;
            }
        }
    })
    .catch(error => {
        outputDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>Error de conexi√≥n:</strong> ${error}
            </div>
        `;
    });
}

// Agregar shortcut Ctrl+Enter para ejecutar
document.getElementById('sql-query').addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.key === 'Enter') {
        e.preventDefault();
        executeSQL();
    }
});
</script>

{% endblock %}
